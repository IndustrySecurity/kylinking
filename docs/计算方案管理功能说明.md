# 计算方案管理功能说明

## 功能概述

计算方案管理是KylinKing薄膜制造管理系统的核心计算引擎，用于创建和管理各种业务计算公式。该功能提供了强大的可视化公式编辑器，支持复杂的条件逻辑和参数化计算，为整个系统的自动化计算提供基础支持。

## 主要特性

### 1. 方案分类管理
支持以下业务场景的计算方案：
- **袋型规格**：袋型尺寸和规格计算
- **袋型公式**：袋型制造工艺公式  
- **袋型报价**：袋型产品报价计算
- **材料用料**：原材料用量计算
- **材料报价**：材料成本和报价
- **工序报价**：生产工序成本计算
- **工序损耗**：生产过程损耗率计算
- **工序节约奖**：节约成本奖励计算
- **工序计件**：按件计酬计算
- **工序其它**：其他工序相关计算
- **倍送公式**：倍数计算公式

### 2. 智能公式编辑器
- **参数选择器**：从计算参数库中选择预定义参数
- **可视化计算器**：提供数字、运算符、逻辑函数的快速输入
- **公式编辑区**：支持手动编辑和智能格式化
- **实时验证**：前端+后端双重验证确保公式正确性
- **语法提示**：实时显示参数数量、字符串数量、行数等信息
- **公式模板**：提供常用公式模板快速构建

### 3. 增强的计算器功能
- **数字输入**：0-9、00（快速输入）、小数点
- **基本运算**：+、-、×、÷（自动添加空格）
- **比较运算**：>、<、>=、<=、=、<>（不等于）
- **逻辑关键词**：如果、那么、或者、并且、否则、结束
- **括号支持**：()用于表达式分组

### 4. 公式验证系统
- **语法检查**：括号匹配、引号匹配、运算符合法性
- **参数验证**：检查参数是否在系统中存在且已启用
- **大小写提示**：智能识别参数名称大小写问题
- **格式建议**：提供空格、命名规范等建议
- **错误定位**：具体指出错误位置和修复方法

## 公式语法规范

### 基本语法规则
1. **参数引用**：使用中括号包围，如 `[长度]`、`[宽度]`
2. **字符串**：使用单引号包围，如 `'塑料'`、`'标准型'`
3. **数字**：支持整数和小数，如 `100`、`1.5`、`0.05`
4. **空格使用**：建议在运算符前后添加空格提高可读性
5. **注释**：暂不支持注释，建议在描述字段中说明

### 运算符说明
- **算术运算**：`+`（加）、`-`（减）、`*`（乘）、`/`（除）
- **比较运算**：`>`（大于）、`<`（小于）、`>=`（大于等于）、`<=`（小于等于）、`=`（等于）、`<>`（不等于）
- **逻辑关键词**：`如果`、`那么`、`否则`、`结束`、`或者`、`并且`

### 公式示例

#### 1. 基本计算
```
[长度] * [宽度] * [厚度]
```

#### 2. 条件计算
```
如果 [长度] > 100 那么 [长度] * [宽度] * 1.2 否则 [长度] * [宽度] 结束
```

#### 3. 字符串条件
```
如果 [材料类型] = '塑料' 那么 [基础价格] * 1.1 否则 [基础价格] 结束
```

#### 4. 复合条件
```
如果 [材料类型] = '塑料' 并且 [厚度] > 0.5 那么 [长度] * [宽度] * 2.0 否则 [长度] * [宽度] * 1.5 结束
```

#### 5. 多级判断
```
如果 [长度] > 200 那么 
  [长度] * [宽度] * 1.5 
否则 
  如果 [长度] > 100 那么 
    [长度] * [宽度] * 1.2 
  否则 
    [长度] * [宽度] 
  结束 
结束
```

#### 6. 复杂业务逻辑
```
如果 [订单数量] >= 1000 并且 [客户等级] = 'VIP' 那么 
  [单价] * [订单数量] * 0.85 
否则 
  如果 [订单数量] >= 500 那么 
    [单价] * [订单数量] * 0.9 
  否则 
    [单价] * [订单数量] 
  结束 
结束
```

## 使用方法

### 1. 创建计算方案
1. 进入"基础档案" → "计算方案管理"
2. 点击"新增方案"按钮
3. 填写基本信息：
   - **方案名称**：给方案起一个有意义的名称
   - **方案分类**：选择适合的业务分类
   - **描述**：详细说明方案用途和计算逻辑
   - **排序**：设置显示顺序
   - **启用状态**：控制方案是否可用
4. 构建公式：
   - 从左侧参数列表选择需要的参数
   - 使用右侧计算器输入数字和运算符
   - 在公式编辑区手动调整和完善
5. 验证公式：点击"验证公式"确保语法正确
6. 保存方案

### 2. 公式编辑技巧
- **参数插入**：点击参数列表中的"插入"按钮，系统会自动添加适当空格
- **计算器使用**：点击按钮会在光标位置插入内容，运算符会自动添加空格
- **语法说明**：点击"语法说明"查看详细规则和示例
- **公式模板**：点击"公式模板"选择常用模板快速开始
- **实时提示**：编辑过程中查看参数数量、字符串数量等统计信息

### 3. 公式验证和调试
1. **前端验证**：编辑时实时检查基本语法
2. **后端验证**：点击"验证公式"进行深度检查
3. **错误处理**：根据错误提示逐步修正问题
4. **警告信息**：注意格式建议，提高公式质量

## 其他功能中的公式应用

### 1. 销售报价模块
**应用场景**：产品报价计算
**使用方式**：
1. 在报价单中选择对应的"袋型报价"或"材料报价"方案
2. 系统自动获取客户订单中的参数值（如长度、宽度、数量等）
3. 代入计算方案公式进行自动计算
4. 生成最终报价金额

**示例**：
```javascript
// 报价模块调用计算方案
const priceScheme = getCalculationScheme('袋型报价', '标准袋型');
const params = {
  '长度': orderInfo.length,
  '宽度': orderInfo.width,
  '数量': orderInfo.quantity,
  '材料类型': orderInfo.materialType
};
const finalPrice = executeFormula(priceScheme.formula, params);
```

### 2. 生产计划模块
**应用场景**：材料用量计算、工序时间估算
**使用方式**：
1. 创建生产计划时选择相关计算方案
2. 根据产品规格和订单数量计算材料需求
3. 使用工序计算方案估算生产时间和成本

**公式示例**：
```
// 材料用料方案
如果 [产品类型] = '复合袋' 那么 
  ([长度] + 20) * ([宽度] + 15) * [数量] * 1.05 
否则 
  [长度] * [宽度] * [数量] * 1.02 
结束
```

### 3. 成本核算模块
**应用场景**：产品成本计算、损耗率计算
**使用方式**：
1. 选择"工序损耗"、"工序报价"等相关方案
2. 系统根据实际生产数据计算成本
3. 生成成本分析报告

### 4. 薪酬管理模块
**应用场景**：计件工资、奖金计算
**使用方式**：
1. 使用"工序计件"方案计算员工计件工资
2. 使用"工序节约奖"方案计算节约奖励
3. 系统自动汇总生成工资单

**公式示例**：
```
// 计件工资方案
如果 [完成数量] >= [标准产量] * 1.2 那么 
  [完成数量] * [单价] * 1.15 
否则 
  如果 [完成数量] >= [标准产量] 那么 
    [完成数量] * [单价] * 1.05 
  否则 
    [完成数量] * [单价] 
  结束 
结束
```

### 5. 质量管理模块
**应用场景**：质量指标计算、合格率统计
**使用方式**：
1. 定义质量相关的计算参数
2. 创建质量评估的计算方案
3. 系统自动计算质量指标

### 6. API调用方式
其他模块可以通过API调用计算方案：

```javascript
// 获取计算方案
GET /api/calculation-schemes?category=袋型报价

// 执行计算（需要在各模块中实现）
POST /api/calculation/execute
{
  "schemeId": "方案ID",
  "parameters": {
    "长度": 100,
    "宽度": 80,
    "数量": 1000
  }
}
```

## 最佳实践

### 1. 方案设计原则
- **模块化**：将复杂计算拆分为多个简单方案
- **可读性**：使用有意义的参数名称和清晰的逻辑结构
- **可维护性**：在描述中详细说明计算逻辑和业务规则
- **测试性**：创建测试用例验证计算结果的正确性

### 2. 参数管理
- **规范命名**：使用统一的参数命名规范
- **分类管理**：按业务模块组织参数
- **版本控制**：重要参数变更时保留历史版本
- **权限控制**：限制关键参数的修改权限

### 3. 公式优化
- **性能考虑**：避免过于复杂的嵌套逻辑
- **精度控制**：注意浮点数计算的精度问题
- **边界处理**：考虑极值情况的处理
- **错误处理**：预设异常情况的处理逻辑

### 4. 集成建议
- **标准化接口**：定义统一的计算方案调用接口
- **缓存机制**：对频繁使用的方案进行缓存
- **日志记录**：记录计算过程和结果用于审计
- **监控告警**：监控计算异常和性能问题

## 技术特性

### 1. 数据安全
- **租户隔离**：确保多租户环境下的数据安全
- **权限控制**：基于角色的访问控制
- **审计跟踪**：完整的操作日志记录
- **数据备份**：定期备份重要的计算方案

### 2. 性能优化
- **智能缓存**：缓存常用方案和参数
- **懒加载**：按需加载数据减少初始加载时间
- **分页查询**：大数据量时的分页处理
- **索引优化**：数据库查询性能优化

### 3. 扩展性设计
- **插件架构**：支持自定义函数和运算符
- **API开放**：提供完整的API供外部系统调用
- **多语言支持**：支持国际化扩展
- **版本兼容**：向后兼容的版本升级机制

## 故障排除

### 1. 常见问题

#### 公式验证失败
- **检查参数名称**：确保参数在计算参数表中存在且已启用
- **检查语法**：注意括号匹配、引号匹配
- **检查大小写**：参数名称区分大小写
- **检查特殊字符**：避免使用非法字符

#### 计算结果异常
- **验证输入参数**：确保参数值的类型和范围正确
- **检查公式逻辑**：验证条件判断和计算逻辑
- **测试边界情况**：测试极值和特殊情况
- **查看执行日志**：分析计算过程中的中间结果

#### 性能问题
- **优化公式复杂度**：减少不必要的嵌套和计算
- **检查参数数量**：避免引用过多参数
- **优化数据查询**：确保相关数据的查询效率
- **监控系统资源**：检查CPU和内存使用情况

### 2. 调试技巧
- **分步验证**：将复杂公式拆分为简单部分逐一验证
- **日志分析**：利用系统日志追踪问题
- **对比测试**：与手工计算结果进行对比
- **版本回退**：出现问题时回退到稳定版本

## 更新日志

### v2.0.0 (2025-05-30)
- ✨ 新增智能公式验证系统
- ✨ 新增公式模板和语法说明功能
- ✨ 新增实时语法提示和统计信息
- 🔧 改进参数验证逻辑，支持大小写提示
- 🔧 优化计算器界面，移除无用按钮
- 🔧 完善错误提示和修复建议
- 📚 更新文档，新增其他功能集成说明

### v1.0.0 (2025-05-30)
- 🎉 初始版本发布
- ✨ 基本的方案管理功能
- ✨ 可视化公式编辑器
- ✨ 计算器和参数选择功能
- 🏗️ 建立基础架构和数据模型 